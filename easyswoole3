FROM centos:7

#version defined
ENV SWOOLE_VERSION 4.4.12
ENV PHP_VERSION php74
ENV EASYSWOOLE_VERSION 3.x-dev

RUN rpm -ivh --force --nodeps http://dl.fedoraproject.org/pub/epel/7/x86_64/Packages/e/epel-release-7-12.noarch.rpm
RUN rpm --import /etc/pki/rpm-gpg/RPM-GPG-KEY-EPEL-7

RUN rpm -ivh --force --nodeps  http://rpms.famillecollet.com/enterprise/remi-release-7.rpm
RUN rpm --import http://rpms.famillecollet.com/RPM-GPG-KEY-remi

# wget
RUN yum install -y wget
# use aliyun centos
RUN yum clean all
RUN yum makecache

# install libs
RUN yum install -y deltarpm curl zip unzip openssl-devel gcc-c++ make libtool autoconf automake git svn net-tools telnet-server redis telnet-server.x86_64 telnet.x86_64 xinetd.x86_64 pcre-devel pcre pcre-devel zlib zlib-devel psmisc ImageMagick-devel
RUN yum install -y memcached libmemcached
RUN mkdir -p /usr/lib/x86_64-linux-gnu/include/libmemcached \
&& ln -s /usr/include/libmemcached/memcached.h /usr/lib/x86_64-linux-gnu/include/libmemcached/memcached.h

#install php
RUN yum install --enablerepo=remi-${PHP_VERSION} -y php php-fpm php-gd php-mbstring php-mcrypt php-mysqlnd php-cli php-devel php-common composer
RUN composer config -g repo.packagist composer https://mirrors.aliyun.com/composer/

# swoole ext
RUN wget https://github.com/swoole/swoole-src/archive/v${SWOOLE_VERSION}.tar.gz -O swoole.tar.gz \
    && mkdir -p swoole \
    && tar -xf swoole.tar.gz -C swoole --strip-components=1 \
    && rm swoole.tar.gz \
    && ( \
    cd swoole \
    && phpize \
    && ./configure --enable-openssl \
    && make \
    && make install \
    ) \
    && sed -i "2i extension=swoole.so" /etc/php.ini \
    && rm -r swoole

# redis ext
RUN wget http://pecl.php.net/get/redis-5.2.2.tgz -O redis.tar.gz \
    && mkdir -p redis \
    && tar zxvf redis.tar.gz -C redis --strip-components=1 \
    && rm redis.tar.gz \
    && ( \
    cd redis \
    && phpize \
    && ./configure --enable-redis \
    && make \
    && make install \
    ) \
    && echo 'extension=redis.so' > /etc/php.d/20-redis.ini \
    && rm -r redis

# imagick ext
RUN wget http://pecl.php.net/get/imagick-3.4.4.tgz -O imagick.tar.gz \
    && mkdir -p imagick \
    && tar zxvf imagick.tar.gz -C imagick --strip-components=1 \
    && rm imagick.tar.gz \
    && ( \
    cd imagick \
    && phpize \
    && ./configure  \
    && make \
    && make install \
    ) \
    && echo 'extension=imagick.so' > /etc/php.d/20-imagick.ini \
    && rm -r imagick

# inotify
RUN wget http://pecl.php.net/get/inotify-2.0.0.tgz -O inotify.tar.gz \
    && mkdir -p inotify \
    && tar zxvf inotify.tar.gz -C inotify --strip-components=1 \
    && rm inotify.tar.gz \
    && ( \
    cd inotify \
    && phpize \
    && ./configure  \
    && make \
    && make install \
    ) \
    && echo 'extension=inotify.so' > /etc/php.d/20-inotify.ini \
    && rm -r inotify

# fswatch ext
RUN wget https://github.com/emcrisostomo/fswatch/releases/download/1.11.0/fswatch-1.11.0.tar.gz -O fswatch.tar.gz \
    && mkdir -p fswatch \
    && tar zxvf fswatch.tar.gz -C fswatch --strip-components=1 \
    && rm fswatch.tar.gz \
    && ( \
    cd fswatch \
    && ./configure  \
    && make \
    && make install  \
    ) \
    && rm -r fswatch

## Dir
WORKDIR /mnt/server/php

CMD ["tailf", "/dev/null"]
